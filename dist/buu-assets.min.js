var BUU=function(){"use strict";var e="https://dev.api.buu.fun",l=null,o={},r={};function n(){return"undefined"!=typeof window&&void 0!==window.THREE&&null!==window.THREE}function t(){return!!l||n()&&void 0!==window.THREE.GLTFLoader}function a(l){var o=e;return"/"===o[o.length-1]&&(o=o.slice(0,-1)),o+l}function i(e){var l=a("/v1/models/public/"+e);return fetch(l).then(function(l){if(!l.ok)throw new Error("HTTP "+l.status+" fetching model "+e);return l.json()})}function u(e){var l=a("/v1/worlds/public/"+e);return fetch(l).then(function(l){if(!l.ok)throw new Error("HTTP "+l.status+" fetching world "+e);return l.json()})}function s(e){if(!n())return console.warn("[BUU] createPlaceholderBox: THREE.js not loaded — returning null"),null;var l=window.THREE,o=e||{},r=o.width||1,t=o.height||1,a=o.depth||1,i=o.color||"#888888",u=new l.BoxGeometry(r,t,a),s=new l.MeshStandardMaterial?new l.MeshStandardMaterial({color:i,roughness:.8,metalness:.1}):new l.MeshBasicMaterial({color:i}),d=new l.Mesh(u,s);return d.name="buu-placeholder",d._isPlaceholder=!0,d}function d(e){return e.texturedMesh&&e.texturedMesh.url?e.texturedMesh.url:e.optimizedMesh&&e.optimizedMesh.url?e.optimizedMesh.url:e.mesh&&e.mesh.url?e.mesh.url:null}function c(){for(var e in r)r.hasOwnProperty(e)&&clearTimeout(r[e]);r={}}function h(e){if(e.splatFiles){if(e.splatFiles.highRes&&e.splatFiles.highRes.url)return e.splatFiles.highRes.url;if(e.splatFiles.mediumRes&&e.splatFiles.mediumRes.url)return e.splatFiles.mediumRes.url;if(e.splatFiles.lowRes&&e.splatFiles.lowRes.url)return e.splatFiles.lowRes.url}return null}function m(e){var l=e.splatFiles||{};return{lowRes:l.lowRes&&l.lowRes.url||null,mediumRes:l.mediumRes&&l.mediumRes.url||null,highRes:l.highRes&&l.highRes.url||null}}return{setApiUrl:function(l){e=l||"https://dev.api.buu.fun"},getApiUrl:function(){return e},setGLTFLoader:function(e){l=e},loadModel:function(e,a){if(!n())return console.warn("[BUU] loadModel: THREE.js not loaded — returning null"),Promise.resolve(null);var u=window.THREE,c=a||{},h=void 0===c.poll||c.poll,m=c.pollInterval||5e3,f=c.maxPollTime||3e5,w=c.onSwap||function(){},p=c.onError||function(){},v=c.onProgress||function(){},g="model:"+e;if(o[g]&&o[g].loaded)return Promise.resolve(o[g].group);var U=new u.Group;U.name="buu-model-"+e,U._buuModelId=e,U._buuLoaded=!1;var T=s({width:c.width,height:c.height,depth:c.depth,color:c.color});return T&&U.add(T),o[g]={group:U,loaded:!1},function(e,a,u,s,c,h,m,f,w){var p=Date.now(),v="model:"+e;function g(){i(e).then(function(i){w(i);var U,T,M=d(i);if(M){if(!t())return console.warn("[BUU] GLTFLoader not available — model "+e+" will remain as placeholder"),void f(new Error("GLTFLoader not available"));(U=M,T=l||n()&&window.THREE.GLTFLoader,T?new Promise(function(e,l){(new T).load(U,function(l){e(l.scene)},void 0,function(e){l(e||new Error("Failed to load GLB: "+U))})}):Promise.reject(new Error("GLTFLoader not available — call BUU.setGLTFLoader(GLTFLoader) first"))).then(function(l){u&&u.parent===a&&(a.remove(u),u.geometry&&u.geometry.dispose(),u.material&&u.material.dispose()),l.name="buu-mesh-"+e,a.add(l),a._buuLoaded=!0,a._buuModelData=i,o[v].loaded=!0,r[e]&&(clearTimeout(r[e]),delete r[e]),m(l,i)}).catch(function(l){console.warn("[BUU] Failed to load GLB for model "+e+": "+l.message),f(l),s&&Date.now()-p<h&&(r[e]=setTimeout(g,c))})}else s&&Date.now()-p<h?r[e]=setTimeout(g,c):s?(console.warn("[BUU] Max poll time reached for model "+e+" — giving up"),f(new Error("Max poll time reached for model "+e))):console.warn("[BUU] No mesh available for model "+e+" and polling is disabled")}).catch(function(l){console.warn("[BUU] Error fetching model "+e+": "+l.message),f(l),s&&Date.now()-p<h&&(r[e]=setTimeout(g,c))})}g()}(e,U,T,h,m,f,w,p,v),Promise.resolve(U)},loadWorld:function(e,l){var n=l||{},t=void 0===n.poll||n.poll,a=n.pollInterval||5e3,i=n.maxPollTime||3e5,s=n.onReady||function(){},d=n.onError||function(){},c=n.onProgress||function(){},f="world:"+e;return o[f]&&o[f].ready?Promise.resolve(o[f].data):new Promise(function(l,n){var w=Date.now(),p=!1;!function v(){u(e).then(function(n){c(n);var u=h(n),g=m(n),U={worldId:e,splatUrl:u,splats:g,panoramaUrl:n.panoMedia&&n.panoMedia.url||null,thumbnailUrl:n.thumbnailMedia&&n.thumbnailMedia.url||null,colliderMeshUrl:n.colliderMesh&&n.colliderMesh.url||null,inputImages:n.inputImages||[],caption:n.caption||null,displayName:n.displayName||null,status:n.status||null,raw:n};!(!u&&!U.panoramaUrl)?(o[f]={data:U,ready:!0},r["world:"+e]&&(clearTimeout(r["world:"+e]),delete r["world:"+e]),p||(p=!0,l(U)),s(U)):t&&Date.now()-w<i?(p||(p=!0,l(U)),r["world:"+e]=setTimeout(v,a)):(p||(p=!0,l(U)),t?(console.warn("[BUU] Max poll time reached for world "+e),d(new Error("Max poll time reached for world "+e))):console.warn("[BUU] No assets available for world "+e+" and polling is disabled"))}).catch(function(l){console.warn("[BUU] Error fetching world "+e+": "+l.message),d(l),t&&Date.now()-w<i?r["world:"+e]=setTimeout(v,a):p||(p=!0,n(l))})}()})},fetchModel:i,fetchWorld:u,createPlaceholderBox:s,resolveMeshUrl:d,resolveAllFormats:function(e){var l=d(e),o=null;e.obj&&(o=d(e.obj));var r=null;return e.fbx&&(r=d(e.fbx)),{glb:l,obj:o,fbx:r}},resolveSplatUrl:h,resolveAllSplatUrls:m,cancelPoll:function(e){r[e]&&(clearTimeout(r[e]),delete r[e])},cancelAllPolls:c,getCachedModel:function(e){var l=o["model:"+e];return l?{group:l.group,loaded:l.loaded}:null},getCachedWorld:function(e){var l=o["world:"+e];return l&&l.data||null},clearCache:function(){c(),o={}},isThreeAvailable:n,isGLTFLoaderAvailable:t}}();
