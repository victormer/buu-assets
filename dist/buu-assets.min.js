var BUU=function(){"use strict";var e="https://dev.api.buu.fun",l={},o={};function r(){return"undefined"!=typeof window&&void 0!==window.THREE&&null!==window.THREE}function n(){return r()&&void 0!==window.THREE.GLTFLoader}function t(l){var o=e;return"/"===o[o.length-1]&&(o=o.slice(0,-1)),o+l}function a(e){var l=t("/api/v1/models/public/"+e);return fetch(l).then(function(l){if(!l.ok)throw new Error("HTTP "+l.status+" fetching model "+e);return l.json()})}function i(e){var l=t("/api/v1/worlds/public/"+e);return fetch(l).then(function(l){if(!l.ok)throw new Error("HTTP "+l.status+" fetching world "+e);return l.json()})}function u(e){if(!r())return console.warn("[BUU] createPlaceholderBox: THREE.js not loaded — returning null"),null;var l=window.THREE,o=e||{},n=o.width||1,t=o.height||1,a=o.depth||1,i=o.color||"#888888",u=new l.BoxGeometry(n,t,a),s=new l.MeshStandardMaterial?new l.MeshStandardMaterial({color:i,roughness:.8,metalness:.1}):new l.MeshBasicMaterial({color:i}),d=new l.Mesh(u,s);return d.name="buu-placeholder",d._isPlaceholder=!0,d}function s(e){return e.texturedMesh&&e.texturedMesh.url?e.texturedMesh.url:e.optimizedMesh&&e.optimizedMesh.url?e.optimizedMesh.url:e.mesh&&e.mesh.url?e.mesh.url:null}function d(){for(var e in o)o.hasOwnProperty(e)&&clearTimeout(o[e]);o={}}function c(e){if(e.splatFiles){if(e.splatFiles.highRes&&e.splatFiles.highRes.url)return e.splatFiles.highRes.url;if(e.splatFiles.mediumRes&&e.splatFiles.mediumRes.url)return e.splatFiles.mediumRes.url;if(e.splatFiles.lowRes&&e.splatFiles.lowRes.url)return e.splatFiles.lowRes.url}return null}function h(e){var l=e.splatFiles||{};return{lowRes:l.lowRes&&l.lowRes.url||null,mediumRes:l.mediumRes&&l.mediumRes.url||null,highRes:l.highRes&&l.highRes.url||null}}return{setApiUrl:function(l){e=l||"https://dev.api.buu.fun"},getApiUrl:function(){return e},loadModel:function(e,t){if(!r())return console.warn("[BUU] loadModel: THREE.js not loaded — returning null"),Promise.resolve(null);var i=window.THREE,d=t||{},c=void 0===d.poll||d.poll,h=d.pollInterval||5e3,m=d.maxPollTime||3e5,f=d.onSwap||function(){},w=d.onError||function(){},p=d.onProgress||function(){},v="model:"+e;if(l[v]&&l[v].loaded)return Promise.resolve(l[v].group);var g=new i.Group;g.name="buu-model-"+e,g._buuModelId=e,g._buuLoaded=!1;var U=u({width:d.width,height:d.height,depth:d.depth,color:d.color});return U&&g.add(U),l[v]={group:g,loaded:!1},function(e,r,t,i,u,d,c,h,m){var f=Date.now(),w="model:"+e;function p(){a(e).then(function(a){m(a);var v=s(a);if(v){if(!n())return console.warn("[BUU] GLTFLoader not available — model "+e+" will remain as placeholder"),void h(new Error("GLTFLoader not available"));(function(e){if(!n())return Promise.reject(new Error("THREE.GLTFLoader not available"));var l=window.THREE;return new Promise(function(o,r){(new l.GLTFLoader).load(e,function(e){o(e.scene)},void 0,function(l){r(l||new Error("Failed to load GLB: "+e))})})})(v).then(function(n){t&&t.parent===r&&(r.remove(t),t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose()),n.name="buu-mesh-"+e,r.add(n),r._buuLoaded=!0,r._buuModelData=a,l[w].loaded=!0,o[e]&&(clearTimeout(o[e]),delete o[e]),c(n,a)}).catch(function(l){console.warn("[BUU] Failed to load GLB for model "+e+": "+l.message),h(l),i&&Date.now()-f<d&&(o[e]=setTimeout(p,u))})}else i&&Date.now()-f<d?o[e]=setTimeout(p,u):i?(console.warn("[BUU] Max poll time reached for model "+e+" — giving up"),h(new Error("Max poll time reached for model "+e))):console.warn("[BUU] No mesh available for model "+e+" and polling is disabled")}).catch(function(l){console.warn("[BUU] Error fetching model "+e+": "+l.message),h(l),i&&Date.now()-f<d&&(o[e]=setTimeout(p,u))})}p()}(e,g,U,c,h,m,f,w,p),Promise.resolve(g)},loadWorld:function(e,r){var n=r||{},t=void 0===n.poll||n.poll,a=n.pollInterval||5e3,u=n.maxPollTime||3e5,s=n.onReady||function(){},d=n.onError||function(){},m=n.onProgress||function(){},f="world:"+e;return l[f]&&l[f].ready?Promise.resolve(l[f].data):new Promise(function(r,n){var w=Date.now(),p=!1;!function v(){i(e).then(function(n){m(n);var i=c(n),g=h(n),U={worldId:e,splatUrl:i,splats:g,panoramaUrl:n.panoMedia&&n.panoMedia.url||null,thumbnailUrl:n.thumbnailMedia&&n.thumbnailMedia.url||null,colliderMeshUrl:n.colliderMesh&&n.colliderMesh.url||null,inputImages:n.inputImages||[],caption:n.caption||null,displayName:n.displayName||null,status:n.status||null,raw:n};!(!i&&!U.panoramaUrl)?(l[f]={data:U,ready:!0},o["world:"+e]&&(clearTimeout(o["world:"+e]),delete o["world:"+e]),p||(p=!0,r(U)),s(U)):t&&Date.now()-w<u?(p||(p=!0,r(U)),o["world:"+e]=setTimeout(v,a)):(p||(p=!0,r(U)),t?(console.warn("[BUU] Max poll time reached for world "+e),d(new Error("Max poll time reached for world "+e))):console.warn("[BUU] No assets available for world "+e+" and polling is disabled"))}).catch(function(l){console.warn("[BUU] Error fetching world "+e+": "+l.message),d(l),t&&Date.now()-w<u?o["world:"+e]=setTimeout(v,a):p||(p=!0,n(l))})}()})},fetchModel:a,fetchWorld:i,createPlaceholderBox:u,resolveMeshUrl:s,resolveAllFormats:function(e){var l=s(e),o=null;e.obj&&(o=s(e.obj));var r=null;return e.fbx&&(r=s(e.fbx)),{glb:l,obj:o,fbx:r}},resolveSplatUrl:c,resolveAllSplatUrls:h,cancelPoll:function(e){o[e]&&(clearTimeout(o[e]),delete o[e])},cancelAllPolls:d,getCachedModel:function(e){var o=l["model:"+e];return o?{group:o.group,loaded:o.loaded}:null},getCachedWorld:function(e){var o=l["world:"+e];return o&&o.data||null},clearCache:function(){d(),l={}},isThreeAvailable:r,isGLTFLoaderAvailable:n}}();
