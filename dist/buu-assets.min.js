var BUU=function(){"use strict";var e="https://dev.api.buu.fun",o=null,l=null,r={},n={};function a(){return"undefined"!=typeof window&&void 0!==window.THREE&&null!==window.THREE}function t(){return!!o||a()&&void 0!==window.THREE.GLTFLoader}function i(o){var l=e;return"/"===l[l.length-1]&&(l=l.slice(0,-1)),l+o}function s(e){var o=i("/v1/models/public/"+e);return fetch(o).then(function(o){if(!o.ok)throw new Error("HTTP "+o.status+" fetching model "+e);return o.json()})}function u(e){var o=i("/v1/worlds/public/"+e);return fetch(o).then(function(o){if(!o.ok)throw new Error("HTTP "+o.status+" fetching world "+e);return o.json()})}function d(e){if(!a())return console.warn("[BUU] createPlaceholderBox: THREE.js not loaded — returning null"),null;var o=window.THREE,l=e||{},r=l.width||1,n=l.height||1,t=l.depth||1,i=l.color||"#888888",s=new o.BoxGeometry(r,n,t),u=new o.MeshStandardMaterial?new o.MeshStandardMaterial({color:i,roughness:.8,metalness:.1}):new o.MeshBasicMaterial({color:i}),d=new o.Mesh(s,u);return d.name="buu-placeholder",d._isPlaceholder=!0,d}function c(e){return e.texturedMesh&&e.texturedMesh.url?e.texturedMesh.url:e.optimizedMesh&&e.optimizedMesh.url?e.optimizedMesh.url:e.mesh&&e.mesh.url?e.mesh.url:null}function p(){for(var e in n)n.hasOwnProperty(e)&&clearTimeout(n[e]);n={}}function w(e){if(e.splatFiles){if(e.splatFiles.highRes&&e.splatFiles.highRes.url)return e.splatFiles.highRes.url;if(e.splatFiles.mediumRes&&e.splatFiles.mediumRes.url)return e.splatFiles.mediumRes.url;if(e.splatFiles.lowRes&&e.splatFiles.lowRes.url)return e.splatFiles.lowRes.url}return null}function h(e){var o=e.splatFiles||{};return{lowRes:o.lowRes&&o.lowRes.url||null,mediumRes:o.mediumRes&&o.mediumRes.url||null,highRes:o.highRes&&o.highRes.url||null}}function f(e,o){var l=o||{},a=void 0===l.poll||l.poll,t=l.pollInterval||5e3,i=l.maxPollTime||3e5,s=l.onReady||function(){},d=l.onError||function(){},c=l.onProgress||function(){},p="world:"+e;return r[p]&&r[p].ready?Promise.resolve(r[p].data):new Promise(function(o,l){var f=Date.now(),m=!1;!function v(){u(e).then(function(l){c(l);var u=w(l),g=h(l),U={worldId:e,splatUrl:u,splats:g,panoramaUrl:l.panoMedia&&l.panoMedia.url||null,thumbnailUrl:l.thumbnailMedia&&l.thumbnailMedia.url||null,colliderMeshUrl:l.colliderMesh&&l.colliderMesh.url||null,inputImages:l.inputImages||[],caption:l.caption||null,displayName:l.displayName||null,status:l.status||null,raw:l};!(!u&&!U.panoramaUrl)?(r[p]={data:U,ready:!0},n["world:"+e]&&(clearTimeout(n["world:"+e]),delete n["world:"+e]),m||(m=!0,o(U)),s(U)):a&&Date.now()-f<i?(m||(m=!0,o(U)),n["world:"+e]=setTimeout(v,t)):(m||(m=!0,o(U)),a?(console.warn("[BUU] Max poll time reached for world "+e),d(new Error("Max poll time reached for world "+e))):console.warn("[BUU] No assets available for world "+e+" and polling is disabled"))}).catch(function(o){console.warn("[BUU] Error fetching world "+e+": "+o.message),d(o),a&&Date.now()-f<i?n["world:"+e]=setTimeout(v,t):m||(m=!0,l(o))})}()})}function m(e,o){var r=l||("undefined"!=typeof window&&window.GaussianSplats3D?window.GaussianSplats3D:null);if(!r)return console.warn("[BUU] loadSplat: GaussianSplats3D not available — call BUU.setGaussianSplats3D() or load via <script>"),Promise.resolve(null);var n=o||{},a=n.onLoad||function(){},t=n.onError||function(){},i={gpuAcceleratedSort:!0,sharedMemoryForWorkers:!0,sphericalHarmonicsDegree:0};r.LogLevel&&(i.logLevel=r.LogLevel.None),r.SceneRevealMode&&(i.sceneRevealMode=r.SceneRevealMode.Gradual);var s,u,d=n.viewer||{},c={};for(s in i)i.hasOwnProperty(s)&&(c[s]=void 0!==d[s]?d[s]:i[s]);for(s in d)d.hasOwnProperty(s)&&void 0===c[s]&&(c[s]=d[s]);try{u=new r.DropInViewer(c)}catch(e){return console.warn("[BUU] Failed to create DropInViewer: "+e.message),t(e),Promise.resolve(null)}var p={splatAlphaRemovalThreshold:void 0!==n.splatAlphaRemovalThreshold?n.splatAlphaRemovalThreshold:5,showLoadingUI:void 0!==n.showLoadingUI&&n.showLoadingUI,progressiveLoad:n.progressiveLoad||!1};return n.position&&(p.position=n.position),n.rotation&&(p.rotation=n.rotation),n.scale&&(p.scale=n.scale),n.format&&(p.format=n.format),u._buuSplatUrl=e,u.addSplatScene(e,p).then(function(){return a(u),u}).catch(function(o){return console.warn("[BUU] Failed to load splat from "+e+": "+(o.message||o)),t(o),null})}return{setApiUrl:function(o){e=o||"https://dev.api.buu.fun"},getApiUrl:function(){return e},setGLTFLoader:function(e){o=e},setGaussianSplats3D:function(e){l=e},loadModel:function(e,l){if(!a())return console.warn("[BUU] loadModel: THREE.js not loaded — returning null"),Promise.resolve(null);var i=window.THREE,u=l||{},p=void 0===u.poll||u.poll,w=u.pollInterval||5e3,h=u.maxPollTime||3e5,f=u.onSwap||function(){},m=u.onError||function(){},v=u.onProgress||function(){},g="model:"+e;if(r[g]&&r[g].loaded)return Promise.resolve(r[g].group);var U=new i.Group;U.name="buu-model-"+e,U._buuModelId=e,U._buuLoaded=!1;var R=d({width:u.width,height:u.height,depth:u.depth,color:u.color});return R&&U.add(R),r[g]={group:U,loaded:!1},function(e,l,i,u,d,p,w,h,f){var m=Date.now(),v="model:"+e;function g(){s(e).then(function(s){f(s);var U,R,T=c(s);if(T){if(!t())return console.warn("[BUU] GLTFLoader not available — model "+e+" will remain as placeholder"),void h(new Error("GLTFLoader not available"));(U=T,R=o||a()&&window.THREE.GLTFLoader,R?new Promise(function(e,o){(new R).load(U,function(o){e(o.scene)},void 0,function(e){o(e||new Error("Failed to load GLB: "+U))})}):Promise.reject(new Error("GLTFLoader not available — call BUU.setGLTFLoader(GLTFLoader) first"))).then(function(o){i&&i.parent===l&&(l.remove(i),i.geometry&&i.geometry.dispose(),i.material&&i.material.dispose()),o.name="buu-mesh-"+e,l.add(o),l._buuLoaded=!0,l._buuModelData=s,r[v].loaded=!0,n[e]&&(clearTimeout(n[e]),delete n[e]),w(o,s)}).catch(function(o){console.warn("[BUU] Failed to load GLB for model "+e+": "+o.message),h(o),u&&Date.now()-m<p&&(n[e]=setTimeout(g,d))})}else u&&Date.now()-m<p?n[e]=setTimeout(g,d):u?(console.warn("[BUU] Max poll time reached for model "+e+" — giving up"),h(new Error("Max poll time reached for model "+e))):console.warn("[BUU] No mesh available for model "+e+" and polling is disabled")}).catch(function(o){console.warn("[BUU] Error fetching model "+e+": "+o.message),h(o),u&&Date.now()-m<p&&(n[e]=setTimeout(g,d))})}g()}(e,U,R,p,w,h,f,m,v),Promise.resolve(U)},loadWorld:f,loadSplat:m,loadWorldSplat:function(e,o){var l=o||{},r=l.splatResolution||"auto",n=l.world||{},a=l.splat||{},t=l.onLoad||function(){},i=l.onError||function(){};return f(e,n).then(function(o){var l;if(!(l="high"===r&&o.splats.highRes?o.splats.highRes:"medium"===r&&o.splats.mediumRes?o.splats.mediumRes:"low"===r&&o.splats.lowRes?o.splats.lowRes:o.splatUrl)){console.warn("[BUU] No splat URL available for world "+e);var n={world:o,viewer:null};return t(n),n}return m(l,a).then(function(e){var l={world:o,viewer:e};return t(l),l})}).catch(function(o){return console.warn("[BUU] Error loading world splat for "+e+": "+(o.message||o)),i(o),{world:null,viewer:null}})},disposeSplat:function(e){if(e&&(e.parent&&e.parent.remove(e),"function"==typeof e.dispose))try{e.dispose()}catch(e){}},fetchModel:s,fetchWorld:u,createPlaceholderBox:d,resolveMeshUrl:c,resolveAllFormats:function(e){var o=c(e),l=null;e.obj&&(l=c(e.obj));var r=null;return e.fbx&&(r=c(e.fbx)),{glb:o,obj:l,fbx:r}},resolveSplatUrl:w,resolveAllSplatUrls:h,cancelPoll:function(e){n[e]&&(clearTimeout(n[e]),delete n[e])},cancelAllPolls:p,getCachedModel:function(e){var o=r["model:"+e];return o?{group:o.group,loaded:o.loaded}:null},getCachedWorld:function(e){var o=r["world:"+e];return o&&o.data||null},clearCache:function(){p(),r={}},isThreeAvailable:a,isGLTFLoaderAvailable:t,isGaussianSplats3DAvailable:function(){return!!l||"undefined"!=typeof window&&void 0!==window.GaussianSplats3D&&null!==window.GaussianSplats3D}}}();
